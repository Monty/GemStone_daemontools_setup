#!/bin/bash

if [ $UID -ne 0 ]; then
   echo "You must be root to run this"
   exit
fi 

echo "DANGER: This script *destroys* things, do NOT run it unless you know what you are doing."
echo "It's used to clean up unnecessary space in the GLASS Appliance before cloning it."
echo "IT MAY BREAK YOUR SYSTEM!"
echo "Continue anyway? (Y/N)"

read cont
case "$cont" in
    y|Y|yes)
    ;;
    *)
    echo "Not continuing"
    exit
    ;;
esac

# Make sure nothing is running related to GemStone
/etc/init.d/topaz stop 1 > /dev/null
/etc/init.d/statmon stop 1 > /dev/null
/etc/init.d/gemstone stop 1 > /dev/null
/etc/init.d/netldi stop 1 > /dev/null

# Reset /etc/issue to remove IP address
/etc/init.d/glass_ip_address stop

# Clear /etc/udev/rules.d/70-persistent-net.rules
cat > /etc/udev/rules.d/70-persistent-net.rules <<-EOF
    # This file was automatically generated by the /lib/udev/write_net_rules
    # program, run by the persistent-net-generator.rules rules file.
    #
    # You can modify it, as long as you keep each rule on a single
    # line, and change only the value of the NAME= key.
EOF

# Quit logging
/etc/init.d/rsyslog stop

cd /

rm -f /home/glass/.bash_history
rm -rf /home/glass/.cache/*
rm -f /home/glass/.lesshist
rm -f /home/glass/.sudo_as_admin_successful
rm -f /home/glass/.viminfo
rm -f /home/glass/.vsd*
rm -f /home/glass/.Xauthority
rm -rf /home/glass/stats
rm -rf /home/glass/*log   # You may have gemnetobject logs

rm -f $GEMSTONE_LOGDIR/*
rm -f $GEMSTONE_LOGDIR/../locks/*
rm -f $GEMSTONE_DATADIR/tranlog*
rm -f $GEMSTONE_DATADIR/*pid

# Get rid of any cached packages
apt-get clean

echo "DANGER: getting ready to remove /root and all /var/log logfiles."
echo "Continue anyway? (Y/N)"

read cont
case "$cont" in
    y|Y|yes)
    ;;
    *)
    echo "Not continuing"
    exit
    ;;
esac

# Now get really down and dirty
rm -rf /root
mkdir /root

for i in `find /var/log -type f`; do
        echo >  $i
done

echo "You should shutdown -h now to clone or snapshot this Appliance"
